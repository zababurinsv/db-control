<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Consensus</title>
</head>
<body>
<noscript>You need to enable JavaScript to run this app.</noscript>
<div id="root"></div>
<script type="module">
    import AppClass from '/modules/consensus/index.js'
    import init from '/modules/blockchain/init.mjs';
    import environment from './assets/model-environment.mjs';
    import jinn from '/modules/blockchain/jinn/src/index.mjs';
    import jinnDbBase from '/modules/blockchain/jinn/src/db/jinn-db-base.mjs';
    import library from '/modules/blockchain/core/library.mjs';
    import node from './assets/model-node.mjs';
    import jinnConnectAddr from '/modules/blockchain/jinn/src/jinn-connect-addr.mjs';
    (async () => {
        let global = {};
        global = await init(global)
        global = await library(global)
        global = await jinnDbBase(global)
        global = await jinn(global)
        global = await node(global)
        global = await environment(global)
        global = await jinnConnectAddr(global)
        let MODEL;
        function InitNodes() {
            MODEL = global.CreateModel(5,1);
        }
        InitNodes()
        MODEL.AddNode(5);

        let app = new AppClass({
            "section1": {
                "extends": "dpow",
            },
            "section2": {
                "extends": "section1"
            },
            "genesis": {
                "id": 'genesis',
                "prev": -1,
                "bits": 1,
                "time": 0,
                "nonce": 0,
            },
            "centralized": {
                "mainNode": "0x0"
            },
            "pow": {
                "premine": 24,
                "blockcount": 12, ///number of blocks in target calculation
                "blocktime": 300, //time of one block in seconds
                "maxtarget": 1, //min difficulty value, we search hash value (uint128) smaller than: hash*target < 2^250
                "excludeFirst": 1, //dont use this numbers blocks in calculation of new target
                "diffWindow": 120, //window of data, used for target
                "diffCut": 6
            },
            'pos': {
                'extends': 'pow',//extending config params from pow section
                //this value is used only for pos/dpos consensus algo, defile how much percent we can decrease in target for stake value, for example: newtarget = (1-shareStake)*target
                'shareStake': 0.1,//max share of stake value that we can decrease from target
            },
            'dpow': {
                'extends': 'pow',
                'delegateMode': true,//new block can emit only public keys from this array or from method data::isDelegateMessage
                //used only for dpow,dpos. We can write static delegates who can send new blocks (check public key of coinbase tx of block, yes, coinbase tx must be signed like another)
                "delegates": ['0x0']//for example we have 1 static delegate in config 0x0, and 1 dynamic 0x2, in data::isDelegateMessage
            },
            'dpos': {
                'extends': 'pos',
                'delegateMode': true,
                'delegates': []
            },
        });

        app.on("debug", (data) => {//debug event
            console.log("[" + new Date().toLocaleTimeString() + "]", "< " + data.level + " >", data.module, data.text);
        });


        app.start('pos');
        // let manager = { }
        // manager.peer = new  app.PEERMANAGER()
        // manager.data = new app.DATAMANAGER()

        // let consensus = new app.CONSENSUS.ProofOfStakeConsensus()

        // let Alice = new app.PEER()
        // let Bob = new app.PEER()
        // let Cooper = new app.PEER()

        // let data = {}
        // data.alice = new app.DATA()
        // data.bob = new app.DATA()
        // data.cooper = new app.DATA()

        // for (let node of MODEL.NetNodeArr) {
        //     app.peerManager.addPeer(node)
        // }
        let {data: Genesis} = app.dataManager.getGenesis()

        const block = new app.DATA({
            id: 2,
            version: 1,
            previd: Genesis.id,
            time: Date.now(),
            nonce: 2,
            bits: 123123123,

        })
        // console.log('block', block)
        app.dataManager.addData(block)

        const {id : prev} = app.dataManager.getTopInfo()
        const block2 = new app.DATA({
            id: 3,
            version: 1,
            previd: prev,
            time: Date.now(),
            nonce: 2,
            bits: 123123123,
        })

        app.dataManager.addData(block2)

        console.log('getHeight', app.dataManager.getHeight())
        console.log('getTopInfo', app.dataManager.getTopInfo())
        // app.dataManager.addData(data.data)
        // console.log('== app ==', app.dataManager.getDataList())

        console.log('== app ==', app)

        // console.log('== service ==', )
        // console.log('== service ==', )
        // console.log('!!!!!!!!!!!!!!!!!!!! === manager === !!!!!!!!!!!!!!!!!!!!', {
        //     manager: manager,
        //     consensus: consensus,
        //     peers: {
        //         Alice: Alice,
        //         Bob: Bob,
        //         Cooper: Cooper
        //     },
        //     data: data
        // })
        // setTimeout(function run() {
        //
        //     console.log('===== manager =====', manager)
        //     setTimeout(run, 1000);
        // }, 1000);

    })()
</script>
</body>
</html>
